name: bootstrap

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Create folders + starter files
        shell: bash
        run: |
          set -euxo pipefail

          mkdir -p bot state web/app web/app/api/state web/app/api/config web/app/api/run-now web/app/config web/app/wallets .github/workflows

          cat > .gitignore <<'EOF'
          **/.env
          **/.venv
          **/__pycache__/
          node_modules/
          .next/
          dist/
          .DS_Store
          EOF

          cat > README.md <<'EOF'
          # Polymarket Paper Bot + Next.js Dashboard (GitHub Actions + Vercel)

          Test-only system:
          - GitHub Actions runs a paper trader every ~5 minutes and writes `state/paper_state.json`
          - Next.js 16+ dashboard reads state and edits `state/config.json` via GitHub API
          EOF

          cat > state/config.json <<'EOF'
          {
            "virtual_usdc_start": 1000,
            "max_usdc_per_trade": 25,
            "max_spread": 0.05,
            "tick": 0.01,
            "edge_ticks": 1,
            "order_ttl_secs": 3600,
            "cooldown_secs": 60,
            "allow_short": false,
            "wallets": []
          }
          EOF

          cat > state/paper_state.json <<'EOF'
          {
            "updated_at": 0,
            "virtual_usdc": 1000.0,
            "positions": {},
            "open_orders": [],
            "fills": [],
            "signals": [],
            "last_seen_ts": {},
            "cooldowns": {},
            "logs": []
          }
          EOF

          cat > bot/requirements.txt <<'EOF'
          py-clob-client
          requests
          EOF

          # Minimal paper runner placeholder (you can paste the full version later)
          cat > bot/papertrade.py <<'EOF'
          print("Bootstrap OK: replace this file with the full papertrade.py from the zip when ready.")
          EOF

          cat > .github/workflows/papertrade.yml <<'EOF'
          name: papertrade

          on:
            schedule:
              - cron: "*/5 * * * *"
            workflow_dispatch: {}

          permissions:
            contents: write

          jobs:
            run-papertrade:
              runs-on: ubuntu-latest
              steps:
                - name: Checkout paper-state branch
                  uses: actions/checkout@v4
                  with:
                    ref: paper-state

                - name: Set up Python
                  uses: actions/setup-python@v5
                  with:
                    python-version: "3.11"

                - name: Install dependencies
                  run: |
                    python -m pip install --upgrade pip
                    pip install -r bot/requirements.txt

                - name: Run papertrade
                  env:
                    CONFIG_PATH: state/config.json
                    STATE_PATH: state/paper_state.json
                    DATA_API_BASE: https://data-api.polymarket.com
                    CLOB_HOST: https://clob.polymarket.com
                  run: |
                    python bot/papertrade.py

                - name: Commit updated state
                  run: |
                    git config user.name "papertrade-bot"
                    git config user.email "papertrade-bot@users.noreply.github.com"
                    git add state/paper_state.json
                    git commit -m "Update paper state" || echo "No changes"
                    git push
          EOF

          # Next.js 16+ minimal skeleton
          cat > web/package.json <<'EOF'
          {
            "name": "polymarket-paperbot-dashboard",
            "private": true,
            "version": "0.1.0",
            "scripts": { "dev": "next dev", "build": "next build", "start": "next start" },
            "dependencies": { "next": "^16.1.0", "react": "^19.2.0", "react-dom": "^19.2.0" },
            "engines": { "node": ">=20" }
          }
          EOF

          cat > web/next.config.js <<'EOF'
          /** @type {import('next').NextConfig} */
          module.exports = { reactStrictMode: true };
          EOF

          cat > web/next-env.d.ts <<'EOF'
          /// <reference types="next" />
          /// <reference types="next/image-types/global" />
          EOF

          cat > web/tsconfig.json <<'EOF'
          { "compilerOptions": { "target": "ES2022", "lib": ["dom","dom.iterable","es2022"], "strict": true, "noEmit": true, "module": "esnext", "moduleResolution": "bundler", "jsx": "preserve" }, "include": ["next-env.d.ts","**/*.ts","**/*.tsx"], "exclude": ["node_modules"] }
          EOF

          cat > web/app/layout.tsx <<'EOF'
          export default function RootLayout({ children }: { children: React.ReactNode }) {
            return (
              <html lang="en">
                <body style={{ margin: 0, fontFamily: "system-ui" }}>
                  <div style={{ borderBottom: "1px solid #eee", padding: 12 }}>
                    <a href="/">Dashboard</a> | <a href="/config">Config</a> | <a href="/wallets">Wallets</a>
                  </div>
                  <div style={{ padding: 16 }}>{children}</div>
                </body>
              </html>
            );
          }
          EOF

          cat > web/app/page.tsx <<'EOF'
          "use client";
          import { useEffect, useState } from "react";
          export default function Page() {
            const [state, setState] = useState<any>(null);
            useEffect(() => { fetch("/api/state").then(r=>r.json()).then(setState); }, []);
            return <pre>{JSON.stringify(state, null, 2)}</pre>;
          }
          EOF

          cat > web/app/api/state/route.ts <<'EOF'
          export const runtime = "nodejs";
          export async function GET() {
            const owner = process.env.GH_OWNER!;
            const repo = process.env.GH_REPO!;
            const branch = process.env.GH_BRANCH || "paper-state";
            const path = process.env.GH_STATE_PATH || "state/paper_state.json";
            const url = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`;
            const r = await fetch(url, { cache: "no-store" });
            return new Response(await r.text(), { status: r.status, headers: { "content-type": "application/json" } });
          }
          EOF

      - name: Commit + push
        shell: bash
        run: |
          set -euxo pipefail
          git config user.name "bootstrap-bot"
          git config user.email "bootstrap-bot@users.noreply.github.com"
          git add -A
          git status
          git commit -m "Bootstrap repo structure" || echo "No changes to commit"
          git push
